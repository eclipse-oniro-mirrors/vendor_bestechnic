From 873bb236b58abb7509024611f936c0ac470a2b48 Mon Sep 17 00:00:00 2001
From: yangjian <jianyang@bestechnic.com>
Date: Fri, 22 Oct 2021 19:30:20 +0800
Subject: [PATCH] feat:utils/native/lite /data

Signed-off-by: yangjian <jianyang@bestechnic.com>
Change-Id: Iebee339dc5318b61472205af5ad34aa356ee75f4
---
 file/src/file_impl_hal/file.c            | 16 +++++++++++++---
 kv_store/src/kvstore_impl_hal/kv_store.c |  3 ++-
 2 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/file/src/file_impl_hal/file.c b/file/src/file_impl_hal/file.c
index 6bce29b..9889d5c 100755
--- a/file/src/file_impl_hal/file.c
+++ b/file/src/file_impl_hal/file.c
@@ -22,10 +22,14 @@
 #include <stdbool.h>
 
 #define BUFFER_SIZE 128
+#define DATA_PRE "/data/"
 
 int UtilsFileOpen(const char* path, int oflag, int mode)
 {
-    return HalFileOpen(path, oflag, mode);
+    char path_real[128] = {0};
+    memcpy(path_real,DATA_PRE,strlen(DATA_PRE));
+    memcpy(path_real+strlen(DATA_PRE),path,strlen(path));
+    return HalFileOpen(path_real, oflag, mode);
 }
 
 int UtilsFileClose(int fd)
@@ -45,12 +49,18 @@ int UtilsFileWrite(int fd, const char* buf, unsigned int len)
 
 int UtilsFileDelete(const char* path)
 {
-    return HalFileDelete(path);
+    char path_real[128] = {0};
+    memcpy(path_real,DATA_PRE,strlen(DATA_PRE));
+    memcpy(path_real+strlen(DATA_PRE),path,strlen(path));
+    return HalFileDelete(path_real);
 }
 
 int UtilsFileStat(const char* path, unsigned int* fileSize)
 {
-    return HalFileStat(path, fileSize);
+    char path_real[128] = {0};
+    memcpy(path_real,DATA_PRE,strlen(DATA_PRE));
+    memcpy(path_real+strlen(DATA_PRE),path,strlen(path));
+    return HalFileStat(path_real, fileSize);
 }
 
 int UtilsFileSeek(int fd, int offset, unsigned int whence)
diff --git a/kv_store/src/kvstore_impl_hal/kv_store.c b/kv_store/src/kvstore_impl_hal/kv_store.c
index 3d4985b..758151a 100755
--- a/kv_store/src/kvstore_impl_hal/kv_store.c
+++ b/kv_store/src/kvstore_impl_hal/kv_store.c
@@ -154,7 +154,8 @@ int UtilsDeleteValue(const char* key)
 #endif
     int ret = UtilsFileDelete(key);
     if (ret == EC_SUCCESS) {
-        ret = SetCurrentItem(GetCurrentItem() - 1);
+        if (GetCurrentItem() > 0)
+            ret = SetCurrentItem(GetCurrentItem() - 1);
     }
     return ret;
 }
-- 
2.17.1

