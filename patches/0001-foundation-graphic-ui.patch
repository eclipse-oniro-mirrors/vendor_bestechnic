From 62c127dca1ff4b03da8127d6ef418f6daa986858 Mon Sep 17 00:00:00 2001
From: zetingxu <zetingxu@bestechnic.com>
Date: Mon, 11 Apr 2022 11:10:14 +0800
Subject: [PATCH] foundation-graphic-ui

Signed-off-by: zetingxu <zetingxu@bestechnic.com>
Change-Id: I255c533a3809b3bff836db999725263d2deedcae
---
 BUILD.gn                                 | 95 +++++++++++++++---------
 frameworks/common/image.cpp              |  2 +-
 frameworks/components/root_view.cpp      |  4 +-
 frameworks/dock/pointer_input_device.cpp |  2 +-
 4 files changed, 61 insertions(+), 42 deletions(-)

diff --git a/BUILD.gn b/BUILD.gn
index a195755..267e85c 100755
--- a/BUILD.gn
+++ b/BUILD.gn
@@ -28,25 +28,27 @@ config("graphic_define_config") {
   include_dirs = [
     "interfaces/kits",
     "interfaces/innerkits",
+    "frameworks",
+    "//third_party/freetype/include",
   ]
 
-  defines = [
-    "ENABLE_VECTOR_FONT=1",
-    "ENABLE_BITMAP_FONT=0",
-    "ENABLE_SHAPING=0",
-    "ENABLE_ICU=1",
-    "ENABLE_MULTI_FONT=0",
-    "DEFAULT_ANIMATION=1"
-  ]
+#  defines = [
+#    "ENABLE_VECTOR_FONT=1",
+#    "ENABLE_BITMAP_FONT=0",
+#    "ENABLE_SHAPING=0",
+#    "ENABLE_ICU=1",
+#    "ENABLE_MULTI_FONT=0",
+#    "DEFAULT_ANIMATION=1"
+#  ]
 
-  if (ohos_kernel_type == "linux") {
-    defines += [ "RESOURCE_DIR=\"/storage/data/\"" ]
-  } else {
-    defines += [ "RESOURCE_DIR=\"/user/data/\"" ]
-  }
+#  if (ohos_kernel_type == "linux") {
+#    defines += [ "RESOURCE_DIR=\"/storage/data/\"" ]
+#  } else {
+#    defines += [ "RESOURCE_DIR=\"/user/data/\"" ]
+#  }
   
   if (enable_graphic_gif) {
-    defines += [ "ENABLE_GIF=1" ]
+    defines = [ "ENABLE_GIF=1" ]
   }
 }
 
@@ -60,7 +62,7 @@ if (enable_graphic_font) {
   }
 }
 
-shared_library("ui") {
+lite_library("ui") {
   sources = [
     "frameworks/animator/animator.cpp",
     "frameworks/animator/animator_manager.cpp",
@@ -166,29 +168,49 @@ shared_library("ui") {
     "frameworks/engines/gfx/hi3516/hi3516_engine.cpp",
   ]
 
-  include_dirs = [ "//foundation/graphic/ui/frameworks" ]
-  deps = [
-    "//build/lite/config/component/cJSON:cjson_shared",
-    "//foundation/graphic/surface:lite_surface",
-    "//foundation/graphic/utils:lite_graphic_hals",
-    "//foundation/graphic/wms:lite_wms",
-    "//third_party/bounds_checking_function:libsec_shared",
-    "//third_party/freetype:freetype",
-    "//third_party/icu/icu4c/source/common:icu_font",
-    "//third_party/libjpeg:libjpeg",
-    "//third_party/libpng:libpng",
-    "//third_party/qrcodegen:qrcodegen",
-  ]
-
-  if (enable_video_component) {
-    defines += [ "ENABLE_VIDEO_COMPONENT=1" ]
-    source += [
-      "frameworks/components/ui_video.cpp",
+  if (ohos_kernel_type == "liteos_m") {
+    target_type = "static_library"
+    sources -= [
+      "frameworks/components/ui_surface_view.cpp",
+      "frameworks/dfx/ui_dump_dom_tree.cpp",
+      "frameworks/dfx/ui_screenshot.cpp",
+      "frameworks/engines/gfx/hi3516/hi3516_engine.cpp",
+      "frameworks/window/window.cpp",
+      "frameworks/window/window_impl.cpp",
+     ]
+    deps = [
+      "//build/lite/config/component/cJSON:cjson_static",
+      "//third_party/bounds_checking_function:libsec_static",
+      "//third_party/freetype:freetype",
+     # "//third_party/icu/icu4c/source/common:icu_font",
+      "//third_party/libjpeg:libjpeg",
+      "//third_party/libpng:libpng",
+      "//third_party/qrcodegen:qrcodegen",
     ]
-
-    deps += [
-      "//foundation/multimedia/media_lite/frameworks/player_lite:player_lite",
+  } else {
+    target_type = "shared_library"
+    deps = [
+      "//build/lite/config/component/cJSON:cjson_shared",
+      "//foundation/graphic/surface:lite_surface",
+      "//foundation/graphic/utils:lite_graphic_hals",
+      "//foundation/graphic/wms:lite_wms",
+      "//third_party/bounds_checking_function:libsec_shared",
+      "//third_party/freetype:freetype",
+      "//third_party/icu/icu4c/source/common:icu_font",
+      "//third_party/libjpeg:libjpeg",
+      "//third_party/libpng:libpng",
+      "//third_party/qrcodegen:qrcodegen",
     ]
+    if (enable_video_component) {
+      defines += [ "ENABLE_VIDEO_COMPONENT=1" ]
+      source += [ "frameworks/components/ui_video.cpp" ]
+
+      deps += [
+        "//foundation/multimedia/media_lite/frameworks/player_lite:player_lite",
+      ]
+    }
+
+    ldflags = [ "-Wl,-rpath-link=$ohos_root_path/$root_out_dir" ]
   }
 
   if (enable_graphic_gif) {
@@ -201,5 +223,4 @@ shared_library("ui") {
     "-fno-exceptions",
   ]
   cflags_cc = cflags
-  ldflags = [ "-Wl,-rpath-link=$ohos_root_path/$root_out_dir" ]
 }
diff --git a/frameworks/common/image.cpp b/frameworks/common/image.cpp
index e88e5fc..53fe26d 100755
--- a/frameworks/common/image.cpp
+++ b/frameworks/common/image.cpp
@@ -387,7 +387,7 @@ bool Image::SetJPEGSrc(const char* src)
     cinfo.err = jpeg_std_error(&jerr);
     jpeg_create_decompress(&cinfo);
     jpeg_stdio_src(&cinfo, infile);
-    jpeg_read_header(&cinfo, TRUE);
+    jpeg_read_header(&cinfo, (boolean)TRUE);
     jpeg_start_decompress(&cinfo);
 
     uint8_t pixelByteSize = DrawUtils::GetPxSizeByColorMode(ARGB8888) >> 3; // 3: Shift right 3 bits
diff --git a/frameworks/components/root_view.cpp b/frameworks/components/root_view.cpp
index d908b9f..91a4390 100755
--- a/frameworks/components/root_view.cpp
+++ b/frameworks/components/root_view.cpp
@@ -529,9 +529,7 @@ void RootView::Render()
         invalidateMap_.clear();
 #else
     if ( invalidateRects_.Size() > 0) {
-        for (ListNode<Rect>* iter = invalidateRects_.Begin(); iter != invalidateRects_.End(); iter = iter->next_) {
-            RenderManager::RenderRect(iter->data_, this);
-        }
+        RenderManager::RenderRect(GetScreenRect(), this); // draw all views
         invalidateRects_.Clear();
 #endif
 
diff --git a/frameworks/dock/pointer_input_device.cpp b/frameworks/dock/pointer_input_device.cpp
index d6032a5..a12e900 100755
--- a/frameworks/dock/pointer_input_device.cpp
+++ b/frameworks/dock/pointer_input_device.cpp
@@ -74,7 +74,7 @@ void PointerInputDevice::DispatchPressEvent(UIViewGroup* rootView)
     if (!pressState_) {
         rootView->GetTargetView(curPos_, &touchableView_, &targetView_);
         if (touchableView_ == nullptr) {
-            GRAPHIC_LOGD("PointerInputDevice::DispatchPressEvent cannot find target view!\n");
+            // GRAPHIC_LOGD("PointerInputDevice::DispatchPressEvent cannot find target view!\n");
             return;
         }
         draggableView_ = GetDraggableView(touchableView_);
-- 
2.17.1

